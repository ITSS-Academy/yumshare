<div class="search-container" id="search-container">
  <h2 id="search-title">Discover Your Favorites</h2>

  <form class="search-bar" id="search-bar" (ngSubmit)="onSearch()">
    <select 
      id="search-type-select" 
      [(ngModel)]="searchType" 
      name="searchType"
      class="search-type-select"
      (ngModelChange)="onSearchTypeChange()"
    >
      <option value="recipe">Search Recipes</option>
      <option value="author">Search by Author</option>
    </select>
    <input
      type="text"
      id="search-input"
      [placeholder]="getSearchPlaceholder()"
      [(ngModel)]="keyword"
      name="keyword"
    />
    <select 
      id="category-select" 
      [(ngModel)]="selectedCategory" 
      name="category"
      [disabled]="searchType === 'author'"
    >
      <option value="">All Categories</option>
      @for (c of categories; track c.id) {
        <option [value]="c.id">{{ c.name }}</option>
      }
    </select>
    <button mat-raised-button color="primary" id="search-button" type="submit">
      <mat-icon>search</mat-icon>
      Search
    </button>
    <button mat-stroked-button color="warn" id="clear-button" type="button" (click)="clearSearch()">
      <mat-icon>clear</mat-icon>
      Clear
    </button>
  </form>

  <!-- @if (getLoadingState() | async) {
    <div class="loading">
      <mat-spinner diameter="40"></mat-spinner>
    </div>
  } -->

  @if (searchError$ | async; as error) {
    <div class="error-container" id="search-error">
      <mat-icon>error</mat-icon>
      <p class="error-message">{{ error }}</p>
      <button mat-raised-button color="primary" (click)="onSearch()">Retry</button>
    </div>
  }

  @if (recipesError$ | async; as error) {
    <div class="error-container" id="recipes-error">
      <mat-icon>error</mat-icon>
      <p class="error-message">{{ error }}</p>
      <button mat-raised-button color="primary" (click)="loadInitialRecipes()">Retry</button>
    </div>
  }

  @if (getSearchStats() | async; as stats) {
    @if (stats.totalResults > 0) {
      <div class="results-info" id="results-info">
        @if (stats.currentQuery) {
          <p>Showing <b>{{ stats.totalResults }}</b> results for: <b>{{ stats.currentQuery }}</b> 
            @if (searchType === 'author') {
              <span class="search-type-badge">(by author)</span>
            } @else {
              <span class="search-type-badge">(recipes)</span>
            }
          </p>
        } @else {
          <p>Showing <b>{{ stats.totalResults }}</b> recipes</p>
        }
        @if (stats.totalPages > 1) {
          <p>Page {{ stats.currentPage }} of {{ stats.totalPages }}</p>
        }
        @if (stats.isLoading) {
          <mat-spinner diameter="20"></mat-spinner>
        }
      </div>
    } @else if (!stats.isLoading && !stats.hasError && stats.currentQuery) {
      <div class="no-results" id="no-results">
        <mat-icon>search_off</mat-icon>
        <p>No results found for "{{ stats.currentQuery }}" 
          @if (searchType === 'author') {
            <span class="search-type-badge">(by author)</span>
          } @else {
            <span class="search-type-badge">(recipes)</span>
          }
        </p>
        <button mat-raised-button color="primary" (click)="clearSearch()">Clear Search</button>
      </div>
    }
  }

  <div class="results-grid-wrapper">
    <div class="results-grid" id="results-grid">
      @for (recipe of displayedResults$ | async; track recipe.id) {
        <div class="recipe-card" (click)="viewRecipe(recipe.id)">
          <img [src]="recipe.image_url || 'https://via.placeholder.com/260x180'" 
               [alt]="recipe.title" 
               class="recipe-image">
          <div class="recipe-content">
            <h3 class="recipe-title">{{ recipe.title }}</h3>
            <p class="recipe-description">{{ recipe.description || 'No description available' }}</p>
            <div class="recipe-info">
              <span class="difficulty" [ngClass]="getDifficultyClass(recipe.difficulty)">
                {{ getDifficultyLabel(recipe.difficulty) }}
              </span>
              <span class="cooking-time">
                <mat-icon>schedule</mat-icon>
                {{ recipe.total_cooking_time }} min
              </span>
            </div>
            <div class="recipe-footer">
              <div class="user-info">
                <img [src]="recipe.user?.avatar_url || 'assets/default-avatar.png'" 
                     [alt]="recipe.user?.username" 
                     class="user-avatar">
                <span class="username">{{ recipe.user?.username || 'Unknown User' }}</span>
              </div>
              <div class="actions">
                <mat-icon (click)="toggleFavorite(recipe); $event.stopPropagation()" 
                         class="favorite-icon">favorite_border</mat-icon>
                <mat-icon (click)="shareRecipe(recipe); $event.stopPropagation()" 
                         class="share-icon">share</mat-icon>
              </div>
            </div>
          </div>
        </div>
      }
    </div>
  </div>

  @if (searchResults$ | async; as searchResults) {
    @if (totalPages > 1) {
      <div class="pagination" id="pagination">
        <button id="first-page-btn" (click)="goToPage(1)" [disabled]="currentPage === 1">«</button>
        <button id="prev-page-btn" (click)="prevPage()" [disabled]="currentPage === 1">‹</button>
        @for (p of visiblePages; track p) {
          <button
            id="page-btn-{{ p }}"
            (click)="goToPage(p)"
            [class.active]="p === currentPage"
          >
            {{ p }}
          </button>
        }
        @if (showEllipsis) {
          <span id="ellipsis">…</span>
        }
        <button id="next-page-btn" (click)="nextPage()" [disabled]="currentPage === totalPages">›</button>
        <button id="last-page-btn" (click)="goToPage(totalPages)" [disabled]="currentPage === totalPages">»</button>
      </div>
    }
  }
</div>
