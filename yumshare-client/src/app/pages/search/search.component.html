<div class="search-container" id="search-container">
  <h2 id="search-title">{{ 'Discover Your Favorites' | translate }}</h2>

  <form class="search-bar" id="search-bar" (ngSubmit)="onSearch()">
    <select 
      id="search-type-select" 
      [(ngModel)]="searchType" 
      name="searchType"
      class="search-type-select"
      (ngModelChange)="onSearchTypeChange()"
    >
      <option value="recipe">{{ 'Recipes' | translate }}</option>
      <option value="author">{{ 'Authors' | translate }}</option>
    </select>
    <input
      type="text"
      id="search-input"
      [placeholder]="getSearchPlaceholder() | translate"
      [(ngModel)]="keyword"
      name="keyword"
    />
    <select 
      id="category-select" 
      [(ngModel)]="selectedCategory" 
      name="category"
      [disabled]="searchType === 'author'"
    >
      <option value="">{{ 'All Categories' | translate }}</option>
      @for (c of categories; track c.id) {
        <option [value]="c.id">{{ c.name | translate }}</option>
      }
    </select>
    <button mat-raised-button color="primary" id="search-button" type="submit">
      <mat-icon>search</mat-icon>
      {{ 'Search' | translate }}
    </button>
    <button mat-stroked-button color="warn" id="clear-button" type="button" (click)="clearSearch()">
      <mat-icon>clear</mat-icon>
      {{ 'Clear' | translate }}
    </button>
  </form>

  <!-- @if (getLoadingState() | async) {
    <div class="loading">
      <mat-spinner diameter="40"></mat-spinner>
    </div>
  } -->

  @if (searchError$ | async; as error) {
    <div class="error-container" id="search-error">
      <mat-icon>error</mat-icon>
      <p class="error-message">{{ error }}</p>
      <button mat-raised-button color="primary" (click)="onSearch()">{{ 'Retry' | translate }}</button>
    </div>
  }

  @if (recipesError$ | async; as error) {
    <div class="error-container" id="recipes-error">
      <mat-icon>error</mat-icon>
      <p class="error-message">{{ error }}</p>
      <button mat-raised-button color="primary" (click)="loadInitialRecipes()">{{ 'Retry' | translate }}</button>
    </div>
  }

  @if (getSearchStats() | async; as stats) {
    @if (stats.totalResults > 0) {
      <div class="results-info" id="results-info">
        @if (stats.currentQuery) {
          <p>
            {{ 'Showing' | translate }} <b>{{ stats.totalResults }}</b> {{ 'results for' | translate }}: <b>{{ stats.currentQuery }}</b> 
            @if (searchType === 'author') {
              <span class="search-type-badge">({{ 'by author' | translate }})</span>
            } @else {
              <span class="search-type-badge">({{ 'recipes' | translate }})</span>
            }
          </p>
        } @else {
          <p>
            {{ 'Showing' | translate }} <b>{{ stats.totalResults }}</b> {{ 'recipes' | translate }}
          </p>
        }
        @if (stats.totalPages > 1) {
          <p>
            {{ 'Page' | translate }} {{ stats.currentPage }} {{ 'of' | translate }} {{ stats.totalPages }}
          </p>
        }
        @if (stats.isLoading) {
          <mat-spinner diameter="20"></mat-spinner>
        }
      </div>
    } @else if (!stats.isLoading && !stats.hasError && stats.currentQuery) {
      <div class="no-results" id="no-results">
        <mat-icon>search_off</mat-icon>
        <p>
          {{ 'No results found for' | translate }} "{{ stats.currentQuery }}" 
          @if (searchType === 'author') {
            <span class="search-type-badge">({{ 'by author' | translate }})</span>
          } @else {
            <span class="search-type-badge">({{ 'recipes' | translate }})</span>
          }
        </p>
        <button mat-raised-button color="primary" (click)="clearSearch()">{{ 'Clear Search' | translate }}</button>
      </div>
    }
  }

  <div class="results-grid-wrapper">
    <app-card [cardData]="displayedResults$ | async" layout="grid"></app-card>
  </div>

  @if (searchResults$ | async; as searchResults) {
    @if (totalPages > 1) {
      <div class="pagination" id="pagination">
        <button id="first-page-btn" (click)="goToPage(1)" [disabled]="currentPage === 1">«</button>
        <button id="prev-page-btn" (click)="prevPage()" [disabled]="currentPage === 1">‹</button>
        @for (p of visiblePages; track p) {
          <button
            id="page-btn-{{ p }}"
            (click)="goToPage(p)"
            [class.active]="p === currentPage"
          >
            {{ p }}
          </button>
        }
        @if (showEllipsis) {
          <span id="ellipsis">…</span>
        }
        <button id="next-page-btn" (click)="nextPage()" [disabled]="currentPage === totalPages">›</button>
        <button id="last-page-btn" (click)="goToPage(totalPages)" [disabled]="currentPage === totalPages">»</button>
      </div>
    }
  }
</div>