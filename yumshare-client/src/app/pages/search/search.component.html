<div class="search-container" id="search-container">
  <h2 id="search-title">Discover Cooking Recipes</h2>

  <div class="search-form-container">
    <form class="search-bar" id="search-bar" (ngSubmit)="onSearch()">
      <!-- Search Type Toggle -->
      <div class="search-type-toggle">
        <button 
          type="button"
          class="toggle-btn"
          [class.active]="searchType === 'recipe'"
          (click)="searchType = 'recipe'; onSearchTypeChange()"
        >
          <mat-icon>restaurant</mat-icon>
          <span>Recipes</span>
        </button>
        <button 
          type="button"
          class="toggle-btn"
          [class.active]="searchType === 'author'"
          (click)="searchType = 'author'; onSearchTypeChange()"
        >
          <mat-icon>person</mat-icon>
          <span>Authors</span>
        </button>
      </div>

      <!-- Main Search Input -->
      <div class="search-input-group">
        <div class="input-wrapper">
          <mat-icon class="input-icon">search</mat-icon>
          <input
            type="text"
            id="search-input"
            [placeholder]="getSearchPlaceholder()"
            [(ngModel)]="keyword"
            name="keyword"
            class="search-input"
            (keydown.enter)="onSearch()"
            autocomplete="off"
          />
          @if (keyword) {
            <button 
              type="button" 
              class="clear-input-btn"
              (click)="keyword = ''"
            >
              <mat-icon>close</mat-icon>
            </button>
          }
        </div>
        
        <!-- Category Filter -->
        <div class="category-filter" [class.disabled]="searchType === 'author'">
          <mat-icon class="filter-icon">restaurant_menu</mat-icon>
          <div class="custom-dropdown" (click)="toggleDropdown()" [class.open]="isDropdownOpen">
            <span class="dropdown-text">
              {{ getSelectedCategoryName() }}
            </span>
            <mat-icon class="dropdown-arrow">{{ isDropdownOpen ? 'expand_less' : 'expand_more' }}</mat-icon>
          </div>
          
          <!-- Dropdown Options -->
          <div class="dropdown-options" [class.show]="isDropdownOpen" *ngIf="isDropdownOpen">
            <div 
              class="dropdown-option" 
              [class.selected]="selectedCategory === ''"
              (click)="selectCategory('')"
            >
              <mat-icon>apps</mat-icon>
              <span>All Categories</span>
            </div>
            @for (category of categories; track category.id) {
              <div 
                class="dropdown-option" 
                [class.selected]="selectedCategory === category.id"
                (click)="selectCategory(category.id)"
              >
                <span>{{ category.name }}</span>
              </div>
            }
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <button 
          mat-raised-button 
          color="primary" 
          id="search-button" 
          type="submit"
          class="search-btn"
          [disabled]="!keyword.trim()"
        >
          <mat-icon>search</mat-icon>
          <span>Search</span>
        </button>
        <button 
          mat-stroked-button 
          color="warn" 
          id="clear-button" 
          type="button" 
          (click)="clearSearch()"
          class="clear-btn"
        >
          <mat-icon>refresh</mat-icon>
          <span>Reset</span>
        </button>
      </div>
    </form>

    <!-- Quick Filters -->
    <div class="quick-filters" *ngIf="searchType === 'recipe' && categories.length > 0">
      <span class="filter-label">
        <mat-icon>tune</mat-icon>
        Quick filters:
      </span>
      <div class="filter-chips">
        <button 
          class="filter-chip"
          [class.active]="selectedCategory === ''"
          (click)="selectedCategory = ''"
        >
          <mat-icon>apps</mat-icon>
          All
        </button>
        @for (category of categories; track category.id) {
          <button 
            class="filter-chip"
            [class.active]="selectedCategory === category.id"
            (click)="selectedCategory = category.id"
          >
            {{ category.name }}
          </button>
        }
      </div>
    </div>
  </div>

  <!-- @if (getLoadingState() | async) {
    <div class="loading">
      <mat-spinner diameter="40"></mat-spinner>
    </div>
  } -->

  @if (searchError$ | async; as error) {
    <div class="error-container" id="search-error">
      <mat-icon>error</mat-icon>
      <p class="error-message">{{ error }}</p>
      <button mat-raised-button color="primary" (click)="onSearch()">Retry</button>
    </div>
  }

  @if (recipesError$ | async; as error) {
    <div class="error-container" id="recipes-error">
      <mat-icon>error</mat-icon>
      <p class="error-message">{{ error }}</p>
      <button mat-raised-button color="primary" (click)="loadInitialRecipes()">Retry</button>
    </div>
  }

  @if (getSearchStats() | async; as stats) {
    @if (stats.totalResults > 0) {
      <div class="results-info" id="results-info">
        @if (stats.currentQuery) {
          <p>Showing <b>{{ stats.totalResults }}</b> results for: <b>{{ stats.currentQuery }}</b> 
            @if (searchType === 'author') {
              <span class="search-type-badge">(by author)</span>
            } @else {
              <span class="search-type-badge">(recipes)</span>
            }
          </p>
        } @else {
          <p>Showing <b>{{ stats.totalResults }}</b> recipes</p>
        }
        @if (stats.totalPages > 1) {
          <p>Page {{ stats.currentPage }} of {{ stats.totalPages }}</p>
        }
        @if (stats.isLoading) {
          <mat-spinner diameter="20"></mat-spinner>
        }
      </div>
    } @else if (!stats.isLoading && !stats.hasError && stats.currentQuery) {
      <div class="no-results" id="no-results">
        <mat-icon>search_off</mat-icon>
        <p>No results found for "{{ stats.currentQuery }}" 
          @if (searchType === 'author') {
            <span class="search-type-badge">(by author)</span>
          } @else {
            <span class="search-type-badge">(recipes)</span>
          }
        </p>
        <button mat-raised-button color="primary" (click)="clearSearch()">Clear Search</button>
      </div>
    }
  }

  <div class="results-grid-wrapper">
    <app-card [cardData]="displayedResults$ | async" layout="grid"></app-card>
  </div>

  @if (searchResults$ | async; as searchResults) {
    @if (totalPages > 1) {
      <div class="pagination" id="pagination">
        <button id="first-page-btn" (click)="goToPage(1)" [disabled]="currentPage === 1">«</button>
        <button id="prev-page-btn" (click)="prevPage()" [disabled]="currentPage === 1">‹</button>
        @for (p of visiblePages; track p) {
          <button
            id="page-btn-{{ p }}"
            (click)="goToPage(p)"
            [class.active]="p === currentPage"
          >
            {{ p }}
          </button>
        }
        @if (showEllipsis) {
          <span id="ellipsis">…</span>
        }
        <button id="next-page-btn" (click)="nextPage()" [disabled]="currentPage === totalPages">›</button>
        <button id="last-page-btn" (click)="goToPage(totalPages)" [disabled]="currentPage === totalPages">»</button>
      </div>
    }
  }
</div>
