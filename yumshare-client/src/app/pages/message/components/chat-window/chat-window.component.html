<div class="chat-window-container" #chatWindowContainer>
  <!-- Chat Header -->
  <div class="chat-header">
    <div class="chat-user-info">
      <button class="back-btn" (click)="onBack()"><mat-icon>arrow_back</mat-icon></button>
      <img
        [src]="safeAvatar(otherUser?.avatar_url)"
        [alt]="otherUser?.username"
        class="chat-user-avatar"
      >
      <div class="chat-user-details">
        <div class="chat-user-name">{{ otherUser?.username || getFallbackUserName() }}</div>
      </div>
    </div>
    <div class="chat-actions">
      <!-- ... -->
    </div>
  </div>

  <!-- Messages Container with Virtual Scrolling -->
  <div class="messages-container">
    @if (messagesLoading) {
      <div class="loading-container">
        <app-chat-message-skeleton></app-chat-message-skeleton>
      </div>
    } @else if (messages && messages.length > 0) {
      <!-- Use Virtual Scrolling for large message lists -->
      @if (messages.length > 50) {
        <div class="virtual-scroll-container">
          <cdk-virtual-scroll-viewport [itemSize]="itemSize" class="messages-viewport">
            @for (message of messages; track trackByMessageId($index, message)) {
              <div 
                class="message-item"
                [class.sent]="message.sender_id === currentUser?.id"
                [class.received]="message.sender_id !== currentUser?.id"
              >
                <div class="message-content">
                  @if (message.sender_id !== currentUser?.id) {
                    <div class="message-meta">
                      <img [src]="safeAvatar(otherUser?.avatar_url)" class="bubble-avatar" alt="avatar">
                    </div>
                  }
                  <div class="message-text">{{ message.content }}</div>
                  <div class="message-time">
                    {{ message.created_at | localTime:'shortTime' }}
                    @if (message.sender_id === currentUser?.id) {
                      <span class="read-status">
                        {{ message.is_read ? '✓✓' : '✓' }}
                      </span>
                    }
                  </div>
                </div>
              </div>
            }
          </cdk-virtual-scroll-viewport>
        </div>
      } @else {
        <!-- Regular scroll for small to medium message lists -->
        <div class="regular-scroll-container">
          @for (message of messages; track trackByMessageId($index, message)) {
            <div 
              class="message-item"
              [class.sent]="message.sender_id === currentUser?.id"
              [class.received]="message.sender_id !== currentUser?.id"
            >
              <div class="message-content">
                @if (message.sender_id !== currentUser?.id) {
                  <div class="message-meta">
                    <img [src]="safeAvatar(otherUser?.avatar_url)" class="bubble-avatar" alt="avatar">
                  </div>
                }
                <div class="message-text">{{ message.content }}</div>
                <div class="message-time">
                  {{ message.created_at | localTime:'shortTime' }}
                  @if (message.sender_id === currentUser?.id) {
                    <span class="read-status">
                      {{ message.is_read ? '✓✓' : '✓' }}
                    </span>
                  }
                </div>
              </div>
            </div>
          }
        </div>
      }
    } @else {
      <!-- No messages state -->
      <div class="no-messages">
        <mat-icon>message</mat-icon>
       <p>{{ 'No messages yet. Start the conversation!' | translate }}</p>
      </div>
    }
  </div>

  <!-- Message Input -->
  <div class="message-input-container">
    <div class="input-wrapper">
      <input
        type="text"
        [placeholder]="'Type a message...' | translate"
        [(ngModel)]="newMessage"
        (input)="onTyping()"
        (keypress)="onKeyPress($event)"
        class="message-input"
      >
      <button
        (click)="sendMessageHandler()"
        [disabled]="!newMessage.trim()"
        class="send-btn"
      >
        <mat-icon>send</mat-icon>
      </button>
    </div>
  </div>
</div>