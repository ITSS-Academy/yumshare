<div class="content-container" #contentContainer>
  <div class="my-recipe-header">
    <h1>{{ 'My Recipes' | translate }}</h1>
    <p>{{ "Here, you can manage all the recipes you've posted. Feel free to click on any recipe to edit or delete it. You can also view comments and feedback from others. Don't forget to keep your recipes updated and share your culinary adventures with the community!" | translate }}</p>
  </div>

  <div class="sort-and-category">
    <div class="difficulty">
      <button mat-button [matMenuTriggerFor]="Difficulty">
        {{ selectedDifficulty | translate }}<span class="material-symbols-outlined">arrow_drop_down</span>
      </button>
      <mat-menu #Difficulty="matMenu">
        <button mat-menu-item (click)="clearDifficultyFilter()">{{ 'All Difficulties' | translate }}</button>
        <button mat-menu-item (click)="setDifficulty('Easy')">{{ 'Easy' | translate }}</button>
        <button mat-menu-item (click)="setDifficulty('Medium')">{{ 'Medium' | translate }}</button>
        <button mat-menu-item (click)="setDifficulty('Hard')">{{ 'Hard' | translate }}</button>
      </mat-menu>
    </div>

    <div class="category">
      <button mat-button [matMenuTriggerFor]="Category">
        {{ selectedCategory | translate }}<span class="material-symbols-outlined">arrow_drop_down</span>
      </button>
      <mat-menu #Category="matMenu">
        <button mat-menu-item (click)="clearCategoryFilter()">{{ 'All Categories' | translate }}</button>
        @for (category of activeCategories$ | async; track category.id) {
          <button mat-menu-item (click)="setCategory(category)">{{ category.name | translate }}</button>
        }
      </mat-menu>
    </div>
  </div>

  <!-- Loading Spinner -->
  @if (recipesLoading$ | async) {
    <div class="loading-container">
      <mat-spinner></mat-spinner>
      <p>{{ 'Loading your recipes...' | translate }}</p>
    </div>
  }

  <!-- Empty State -->
  @if (isEmpty$ | async) {
    <div class="empty-state">
      <mat-icon>restaurant_menu</mat-icon>
      <h3>{{ 'No recipes found' | translate }}</h3>
      <p>{{ "You haven't created any recipes yet. Start sharing your culinary creations!" | translate }}</p>
      <button mat-raised-button color="primary" (click)="router.navigate(['/add-recipe'])">
        {{ 'Create Your First Recipe' | translate }}
      </button>
    </div>
  }

  <!-- Recipes Grid with Conditional Virtual Scrolling -->
  @if (!(recipesLoading$ | async) && !(isEmpty$ | async)) {
    @if ((displayedRecipes$ | async)?.length > 15) {
      <!-- Use Virtual Scrolling for large recipe lists -->
      <div class="virtual-scroll-container">
        <cdk-virtual-scroll-viewport [itemSize]="itemSize" class="recipe-viewport">
          @for (recipe of displayedRecipes$ | async; track trackByRecipeId($index, recipe)) {
          <div class="recipe-card">
            <div class="recipe-image">
              <img [src]="recipe.image_url || 'assets/default-recipe.jpg'" [alt]="recipe.title">
            </div>
            <div class="recipe-content">
              <div class="recipe-header">
                <div class="name-and-author">
                  <h3 class="recipe-title">{{ recipe.title }}</h3>
                  <p class="recipe-author">{{ 'by' | translate }} {{ recipe.user?.username || ('Unknown' | translate) }}</p>
                </div>
                <div class="example-button-row">
                  <div class="example-flex-container">
                    <button mat-icon-button [matMenuTriggerFor]="menu" aria-label="More actions">
                      <mat-icon>more_vert</mat-icon>
                    </button>
                    <mat-menu #menu="matMenu">
                      <button mat-menu-item (click)="onEditRecipe(recipe)">
                        <mat-icon>edit</mat-icon>
                        <span>{{ 'Edit' | translate }}</span>
                      </button>
                      <button mat-menu-item class="delete-menu-item" (click)="onDeleteRecipe(recipe)">
                        <mat-icon class="delete-icon">delete</mat-icon>
                        <span class="delete-text">{{ 'Delete' | translate }}</span>
                      </button>
                    </mat-menu>
                  </div>
                </div>
              </div>
              <div class="recipe-description">
                <p>{{ recipe.description }}</p>
              </div>

              <!-- Additional info -->
              <div class="recipe-meta">
                <span class="recipe-time">{{ recipe.total_cooking_time }} {{ 'min' | translate }}</span>
                <span class="recipe-difficulty" [class]="'recipe-difficulty ' + (recipe.difficulty?.toLowerCase() || '')">{{ recipe.difficulty | translate }}</span>
              </div>

              <!-- Creation date -->
              <div class="recipe-footer">
                <span class="recipe-date">{{ recipe.created_at | date:'dd/MM/yyyy' }}</span>
              </div>
            </div>
          </div>
          }
        </cdk-virtual-scroll-viewport>
      </div>
    } @else {
      <!-- Regular scroll for small recipe lists -->
      <div class="regular-recipe-list">
        @for (recipe of displayedRecipes$ | async; track trackByRecipeId($index, recipe)) {
          <div class="recipe-card">
            <div class="recipe-image">
              <img [src]="recipe.image_url || 'assets/default-recipe.jpg'" [alt]="recipe.title">
            </div>
            <div class="recipe-content">
              <div class="recipe-header">
                <div class="name-and-author">
                  <h3 class="recipe-title">{{ recipe.title }}</h3>
                  <p class="recipe-author">{{ 'by' | translate }} {{ recipe.user?.username || ('Unknown' | translate) }}</p>
                </div>
                <div class="example-button-row">
                  <div class="example-flex-container">
                    <button mat-icon-button [matMenuTriggerFor]="menu" aria-label="More actions">
                      <mat-icon>more_vert</mat-icon>
                    </button>
                    <mat-menu #menu="matMenu">
                      <button mat-menu-item (click)="viewRecipe(recipe.id)">
                        <mat-icon>visibility</mat-icon>
                        <span>{{ 'View' | translate }}</span>
                      </button>
                      <button mat-menu-item (click)="editRecipe(recipe.id)">
                        <mat-icon>edit</mat-icon>
                        <span>{{ 'Edit' | translate }}</span>
                      </button>
                      <button mat-menu-item (click)="deleteRecipe(recipe.id)" class="delete-action">
                        <mat-icon>delete</mat-icon>
                        <span>{{ 'Delete' | translate }}</span>
                      </button>
                    </mat-menu>
                  </div>
                </div>
              </div>
              <div class="recipe-description">
                <p>{{ recipe.description }}</p>
              </div>

              <!-- Additional info -->
              <div class="recipe-meta">
                <span class="recipe-time">{{ recipe.total_cooking_time }} {{ 'min' | translate }}</span>
                <span class="recipe-difficulty" [class]="'recipe-difficulty ' + (recipe.difficulty?.toLowerCase() || '')">{{ recipe.difficulty | translate }}</span>
              </div>

              <!-- Creation date -->
              <div class="recipe-footer">
                <span class="recipe-date">{{ recipe.created_at | date:'dd/MM/yyyy' }}</span>
              </div>
            </div>
          </div>
        }
      </div>
    }

    <!-- Pagination -->
    @if ((totalPages$ | async) && (totalPages$ | async)! > 1) {
      <div class="pagination" id="pagination">
        <button id="first-page-btn" (click)="goToPage(1)" [disabled]="currentPage === 1">«</button>
        <button id="prev-page-btn" (click)="prevPage()" [disabled]="currentPage === 1">‹</button>
        @for (p of visiblePages; track p) {
          <button
            id="page-btn-{{ p }}"
            (click)="goToPage(p)"
            [class.active]="p === currentPage"
          >
            {{ p }}
          </button>
        }
        @if (showEllipsis) {
          <span id="ellipsis">…</span>
        }
        <button id="next-page-btn" (click)="nextPage()" [disabled]="currentPage === totalPages">›</button>
        <button id="last-page-btn" (click)="goToPage(totalPages)" [disabled]="currentPage === totalPages">»</button>
      </div>
    } @else if ((displayedRecipes$ | async)?.length > pageSize) {
      <!-- Fallback pagination for when totalPages is not available -->
      <div class="pagination" id="pagination">
        <button id="first-page-btn" (click)="goToPage(1)" [disabled]="currentPage === 1">«</button>
        <button id="prev-page-btn" (click)="prevPage()" [disabled]="currentPage === 1">‹</button>
        <button id="page-btn-1" (click)="goToPage(1)" [class.active]="currentPage === 1">1</button>
        <button id="page-btn-2" (click)="goToPage(2)" [class.active]="currentPage === 2">2</button>
        <button id="next-page-btn" (click)="nextPage()" [disabled]="currentPage >= 2">›</button>
        <button id="last-page-btn" (click)="goToPage(2)" [disabled]="currentPage >= 2">»</button>
      </div>
    }
  }
</div>