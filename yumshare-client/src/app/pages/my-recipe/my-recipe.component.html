<div class="content-container">
  <div class="my-recipe-header">
    <h1>My Recipes</h1>
    <p>Here, you can manage all the recipes you've posted. Feel free to click on any recipe to edit or delete it. You
      can also view comments and feedback from others. Don't forget to keep your recipes updated and share your culinary
      adventures with the community!</p>
  </div>

  <div class="sort-and-category">
    <div class="difficulty">
      <button mat-button [matMenuTriggerFor]="Difficulty">
        {{ selectedDifficulty }}<span class="material-symbols-outlined">arrow_drop_down</span>
      </button>
      <mat-menu #Difficulty="matMenu">
        <button mat-menu-item (click)="clearDifficultyFilter()">All Difficulties</button>
        <button mat-menu-item (click)="setDifficulty('Easy')">Easy</button>
        <button mat-menu-item (click)="setDifficulty('Medium')">Medium</button>
        <button mat-menu-item (click)="setDifficulty('Hard')">Hard</button>
      </mat-menu>
    </div>

    <div class="category">
      <button mat-button [matMenuTriggerFor]="Category">
        {{ selectedCategory }}<span class="material-symbols-outlined">arrow_drop_down</span>
      </button>
      <mat-menu #Category="matMenu">
        <button mat-menu-item (click)="clearCategoryFilter()">All Categories</button>
        @for (category of activeCategories$ | async; track category.id) {
          <button mat-menu-item (click)="setCategory(category)">{{ category.name }}</button>
        }
      </mat-menu>
    </div>
  </div>

  <!-- Loading Spinner -->
  @if (recipesLoading$ | async) {
    <div class="loading-container">
      <mat-spinner></mat-spinner>
      <p>Loading your recipes...</p>
    </div>
  }

  <!-- Empty State -->
  @if (isEmpty$ | async) {
    <div class="empty-state">
      <mat-icon>restaurant_menu</mat-icon>
      <h3>No recipes found</h3>
      <p>You haven't created any recipes yet. Start sharing your culinary creations!</p>
      <button mat-raised-button color="primary" (click)="router.navigate(['/add-recipe'])">
        Create Your First Recipe
      </button>
    </div>
  }

  <!-- Recipes Grid with Conditional Virtual Scrolling -->
  @if (!(recipesLoading$ | async) && !(isEmpty$ | async)) {
    @if ((displayedRecipes$ | async)?.length > 15) {
      <!-- Use Virtual Scrolling for large recipe lists -->
      <div class="virtual-scroll-container">
        <cdk-virtual-scroll-viewport [itemSize]="itemSize" class="recipe-viewport">
          @for (recipe of displayedRecipes$ | async; track trackByRecipeId($index, recipe)) {
          <div class="recipe-card">
            <div class="recipe-image">
              <img [src]="recipe.image_url || 'assets/default-recipe.jpg'" [alt]="recipe.title">
            </div>
            <div class="recipe-content">
              <div class="recipe-header">
                <div class="name-and-author">
                  <h3 class="recipe-title">{{ recipe.title }}</h3>
                  <p class="recipe-author">by {{ recipe.user?.username || 'Unknown' }}</p>
                </div>
                <div class="example-button-row">
                  <div class="example-flex-container">
                    <button mat-icon-button [matMenuTriggerFor]="menu" aria-label="More actions">
                      <mat-icon>more_vert</mat-icon>
                    </button>
                    <mat-menu #menu="matMenu">
                      <button mat-menu-item (click)="onEditRecipe(recipe)">
                        <mat-icon>edit</mat-icon>
                        <span>Edit</span>
                      </button>
                      <button mat-menu-item class="delete-menu-item" (click)="onDeleteRecipe(recipe)">
                        <mat-icon class="delete-icon">delete</mat-icon>
                        <span class="delete-text">Delete</span>
                      </button>
                    </mat-menu>
                  </div>
                </div>
              </div>
              <div class="recipe-description">
                <p>{{ recipe.description }}</p>
              </div>

              <!-- Additional info -->
              <div class="recipe-meta">
                <span class="recipe-time">{{ recipe.total_cooking_time }} min</span>
                <span class="recipe-difficulty" [class]="'recipe-difficulty ' + (recipe.difficulty?.toLowerCase() || '')">{{ recipe.difficulty }}</span>
              </div>

              <!-- Creation date -->
              <div class="recipe-footer">
                <span class="recipe-date">{{ recipe.created_at | date:'dd/MM/yyyy' }}</span>
              </div>
            </div>
          </div>
          }
        </cdk-virtual-scroll-viewport>
      </div>
    } @else {
      <!-- Regular scroll for small recipe lists -->
      <div class="regular-recipe-list">
        @for (recipe of displayedRecipes$ | async; track trackByRecipeId($index, recipe)) {
          <div class="recipe-card">
            <div class="recipe-image">
              <img [src]="recipe.image_url || 'assets/default-recipe.jpg'" [alt]="recipe.title">
            </div>
            <div class="recipe-content">
              <div class="recipe-header">
                <div class="name-and-author">
                  <h3 class="recipe-title">{{ recipe.title }}</h3>
                  <p class="recipe-author">by {{ recipe.user?.username || 'Unknown' }}</p>
                </div>
                <div class="example-button-row">
                  <div class="example-flex-container">
                    <button mat-icon-button [matMenuTriggerFor]="menu" aria-label="More actions">
                      <mat-icon>more_vert</mat-icon>
                    </button>
                    <mat-menu #menu="matMenu">
                      <button mat-menu-item (click)="viewRecipe(recipe.id)">
                        <mat-icon>visibility</mat-icon>
                        <span>View</span>
                      </button>
                      <button mat-menu-item (click)="editRecipe(recipe.id)">
                        <mat-icon>edit</mat-icon>
                        <span>Edit</span>
                      </button>
                      <button mat-menu-item (click)="deleteRecipe(recipe.id)" class="delete-action">
                        <mat-icon>delete</mat-icon>
                        <span>Delete</span>
                      </button>
                    </mat-menu>
                  </div>
                </div>
              </div>
              <div class="recipe-description">
                <p>{{ recipe.description }}</p>
              </div>

              <!-- Additional info -->
              <div class="recipe-meta">
                <span class="recipe-time">{{ recipe.total_cooking_time }} min</span>
                <span class="recipe-difficulty" [class]="'recipe-difficulty ' + (recipe.difficulty?.toLowerCase() || '')">{{ recipe.difficulty }}</span>
              </div>

              <!-- Creation date -->
              <div class="recipe-footer">
                <span class="recipe-date">{{ recipe.created_at | date:'dd/MM/yyyy' }}</span>
              </div>
            </div>
          </div>
        }
      </div>
    }

    <!-- Pagination -->
    <div class="pages-navigation">
      <div class="example-button-row">
        <div class="example-flex-container">
          <div class="example-button-container">
            <button mat-mini-fab aria-label="First page" (click)="goToFirst()"
              [disabled]="pageIndex === 0">&lt;&lt;</button>
            <button mat-mini-fab aria-label="Previous page" (click)="goToPrev()"
              [disabled]="pageIndex === 0">&lt;</button>
            
            @if ((pageNumbers$ | async)?.[0] > 0) {
              <button mat-mini-fab (click)="goToPage(0)">1</button>
              @if ((pageNumbers$ | async)?.[0] > 1) {
                <span>...</span>
              }
            }
            
            @for (page of pageNumbers$ | async; track page) {
              <button mat-mini-fab [class.active]="page === pageIndex" (click)="goToPage(page)">
                {{ page + 1 }}
              </button>
            }
            
            @if ((pageNumbers$ | async)?.[(pageNumbers$ | async)!.length - 1] < (totalPages$ | async)! - 1) {
              @if ((pageNumbers$ | async)?.[(pageNumbers$ | async)!.length - 1] < (totalPages$ | async)! - 2) {
                <span>...</span>
              }
              <button mat-mini-fab (click)="goToLast()">{{ totalPages$ | async }}</button>
            }
            
            <button mat-mini-fab aria-label="Next page" (click)="goToNext()"
              [disabled]="pageIndex === (totalPages$ | async)! - 1">&gt;</button>
            <button mat-mini-fab aria-label="Last page" (click)="goToLast()"
              [disabled]="pageIndex === (totalPages$ | async)! - 1">&gt;&gt;</button>
          </div>
        </div>
      </div>
    </div>
  }
</div>