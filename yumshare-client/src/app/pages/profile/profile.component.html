<div class="profile-edit" style="user-select: none;">
  <!-- Header -->
  <div class="profile-header">
    <h2>{{ 'Edit Profile' | translate }}</h2>
    <div class="header-actions">
      <button mat-raised-button color="warn" style="background-color: red; color: white;" (click)="showDialog = true">
        <mat-icon>delete</mat-icon>
        {{ 'Delete account' | translate }}
      </button>
    </div>
    @if (showDialog) {
      <div class="dialog-backdrop">
        <div class="dialog-box">
          <h3>{{ 'Delete Account' | translate }}</h3>
          <p>{{ 'Are you sure you want to delete your account?' | translate }}</p>
          <div class="dialog-actions">
            <button mat-button (click)="showDialog = false">
              <mat-icon>cancel</mat-icon>
              {{ 'Cancel' | translate }}
            </button>
            <button mat-raised-button color="warn" (click)="deleteAccount()" style="background-color: red; color: white;">
              <mat-icon>delete</mat-icon>
              {{ 'Delete' | translate }}
            </button>
          </div>
        </div>
      </div>
    }
  </div>

  <!-- Loading State -->
  @if (isLoading$ | async) {
    <app-loading 
      size="large"
      [message]="'Loading profile...' | translate"
      centerType="default">
    </app-loading>
  }

  <!-- Error State -->
  @if (error$ | async; as error) {
    <div class="error-state">
      <p>{{ 'Error:' | translate }} {{ error }}</p>
    </div>
  }

  <!-- Profile Content -->
  @if (!(isLoading$ | async)) {
    <!-- Avatar + Info -->
    <div class="profile-info">
      <div class="avatar-section">
        <div class="avatar-container">
          <div class="avatar-wrapper">
            <img [src]="avatarUrl || 'https://via.placeholder.com/80'" alt="Avatar" class="avatar">
            @if (isUploadingAvatar) {
              <div class="upload-overlay">
                <mat-spinner diameter="30"></mat-spinner>
                <span>Uploading...</span>
              </div>
            }
          </div>
          <input 
            type="file" 
            id="avatar-input"
            accept="image/*" 
            (change)="onAvatarChange($event)" 
            class="avatar-input"
            style="display: none;">
           <button 
             mat-fab 
             color="primary" 
             (click)="onSelectAvatar()"
             [disabled]="isUploadingAvatar"
             class="change-avatar-btn">
             @if (isUploadingAvatar) {
               <mat-spinner diameter="16"></mat-spinner>
             } @else {
               <mat-icon>photo_camera</mat-icon>
             }
           </button>
        </div>
        <div>
          <h3>{{ profileForm.value.name }}</h3>
          <div class="bio-section">
            <textarea 
              class="bio-input" 
              [placeholder]="'Write something about yourself...' | translate"
              [(ngModel)]="introduce"
              (focus)="startEditBio()"
              (blur)="stopEditBio()"
              (keydown)="onBioKeyDown($event)"
            ></textarea>
            <!-- <span class="edit-icon" (click)="toggleBioEdit()">
              <img style="height: 15px; padding-left: 10px" src="https://cdn.pixabay.com/photo/2019/04/08/20/26/pencil-4112898_960_720.png" alt="">
            </span> -->
          </div>
        </div>
      </div>
    </div>

    <!-- Form -->
    <form [formGroup]="profileForm" class="profile-form" (ngSubmit)="onSubmit()">
      <div class="form-row">
        <div class="form-group">
          <label>{{ 'Name' | translate }}</label>
          <input type="text" formControlName="name">
        </div>
        <div class="form-group">
          <label>{{ 'Location' | translate }}</label>
          <input type="text" formControlName="location">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>{{ 'E-mail' | translate }}</label>
          <input type="email" formControlName="email">
        </div>
        <div class="form-group">
          <label>{{ 'Phone' | translate }}</label>
          <input type="text" formControlName="phone">
        </div>
      </div>

      <!-- Social -->
      <div class="social-links">
        <!-- ...icon links giữ nguyên... -->
      </div>

       <!-- Buttons -->
       <div class="form-actions">
         <button mat-raised-button color="primary" type="submit" (click)="onSubmit()" [disabled]="profileForm.invalid || (isLoading$ | async)">
           <mat-icon>save</mat-icon>
           {{ 'Save' | translate }}
         </button>
         <button mat-button type="button" (click)="onCancel()" style="background-color: #ffffff;" [disabled]="isLoading$ | async">
           <mat-icon>cancel</mat-icon>
           {{ 'Cancel' | translate }}
         </button>
       </div>
    </form>

    <!-- Followers/Following Tabs -->
    <div class="social-tabs">
      <button class="tab-button" [class.active]="activeTab === 'followers'" (click)="setActiveTab('followers'); loadFollowers()">{{ 'Followers' | translate }} ({{ followerCount$ | async }})</button>
      <button class="tab-button" [class.active]="activeTab === 'following'" (click)="setActiveTab('following'); loadFollowing()">
         {{ 'Following' | translate }} (
        @if (followIsLoading$ | async) {
          <span class="loading-spinner-small"></span>
        } @else {
          {{ followingCount$ | async }}
        }
        )
      </button>
    </div>

    <!-- Followers/Following Content -->
    <div class="social-content">

      <!-- Loading State -->
      @if (followIsLoading$ | async) {
        <app-loading 
          size="medium"
          [message]="'Loading followers...' | translate"
          centerType="default">
        </app-loading>
      }

      <!-- Error State -->
      @if (followError$ | async; as error) {
        <div class="error-state">
          <p>{{ 'Error:' | translate }} {{ error }}</p>
        </div>
      }

                     <!-- Followers Tab -->
        @if (activeTab === 'followers' && !(followIsLoading$ | async)) {
          <div class="followers">
            @if ((followers$ | async)?.length > 10) {
              <!-- Use Virtual Scrolling for large follower lists -->
              <div class="virtual-scroll-container">
                <cdk-virtual-scroll-viewport [itemSize]="followItemSize" class="follow-viewport">
                  @for (follow of (followers$ | async) || []; track trackByFollowId($index, follow)) {
                  <div class="social-item">
                    <img [src]="follow.follower?.avatar_url || 'https://via.placeholder.com/40'" alt="Avatar" class="small-avatar">
                    <div class="user-info">
                      <span class="user-name">{{ follow.follower?.username || ('Unknown User' | translate) }}</span>
                      <span class="user-bio">{{ follow.follower?.bio || ('No bio available' | translate) }}</span>
                    </div>
                    <div class="user-actions">
                       <button 
                         mat-raised-button 
                         color="primary"
                         (click)="followUser(follow.follower?.id || '')"
                         [disabled]="followIsLoading$ | async">
                         @if (followIsLoading$ | async) {
                           <mat-spinner diameter="16"></mat-spinner>
                           Following...
                         } @else {
                           Follow
                         }
                       </button>
                    </div>
                  </div>
                  }
                  @if (!(followers$ | async) || (followers$ | async)?.length === 0) {
                    <div class="no-data">
                      <p>{{ 'No followers yet' | translate }}</p>
                    </div>
                  }
                </cdk-virtual-scroll-viewport>
              </div>
            } @else {
              <!-- Regular scroll for small follower lists -->
              <div class="regular-follow-list">
                @for (follow of (followers$ | async) || []; track trackByFollowId($index, follow)) {
                  <div class="social-item">
                    <img [src]="follow.follower?.avatar_url || 'https://via.placeholder.com/40'" alt="Avatar" class="small-avatar">
                    <div class="user-info">
                      <span class="user-name">{{ follow.follower?.username || ('Unknown User' | translate) }}</span>
                      <span class="user-bio">{{ follow.follower?.bio || ('No bio available' | translate) }}</span>
                    </div>
                    <div class="user-actions">
                       <button 
                         mat-raised-button 
                         color="primary"
                         (click)="followUser(follow.follower?.id || '')"
                         [disabled]="followIsLoading$ | async">
                         @if (followIsLoading$ | async) {
                           <mat-spinner diameter="16"></mat-spinner>
                           Following...
                         } @else {
                           Follow
                         }
                       </button>
                    </div>
                  </div>
                }
                @if (!(followers$ | async) || (followers$ | async)?.length === 0) {
                  <div class="no-data">
                    <p>No followers yet</p>
                  </div>
                }
              </div>
            }
          </div>
        }

                     <!-- Following Tab -->
        @if (activeTab === 'following' && !(followIsLoading$ | async)) {
          <div class="following">
            @if ((following$ | async)?.length > 10) {
              <!-- Use Virtual Scrolling for large following lists -->
              <div class="virtual-scroll-container">
                <cdk-virtual-scroll-viewport [itemSize]="followItemSize" class="follow-viewport">
                  @for (follow of (following$ | async) || []; track trackByFollowId($index, follow)) {
                  <div class="social-item">
                    <img [src]="follow.following?.avatar_url || 'https://via.placeholder.com/40'" alt="Avatar" class="small-avatar">
                    <div class="user-info">
                      <span class="user-name">{{ follow.following?.username || ('Unknown User' | translate) }}</span>
                      <span class="user-bio">{{ follow.following?.bio || ('No bio available' | translate) }}</span>
                    </div>
                    <div class="user-actions">
                       <button 
                         mat-stroked-button 
                         color="warn"
                         (click)="unfollowUser(follow.following?.id || '')"
                         [disabled]="followIsLoading$ | async">
                         @if (followIsLoading$ | async) {
                           <mat-spinner diameter="16"></mat-spinner>
                           {{ 'Unfollowing...' | translate }}
                         } @else {
                           {{ 'Unfollow' | translate }}
                         }
                       </button>
                    </div>
                  </div>
                }
                @if (!(following$ | async) || (following$ | async)?.length === 0) {
                  <div class="no-data">
                    <p>{{ 'Not following anyone yet' | translate }}</p>
                  </div>
                }
              </cdk-virtual-scroll-viewport>
            </div>
          } @else {
            <!-- Regular scroll for small following lists -->
            <div class="regular-follow-list">
              @for (follow of (following$ | async) || []; track trackByFollowId($index, follow)) {
                <div class="social-item">
                  <img [src]="follow.following?.avatar_url || 'https://via.placeholder.com/40'" alt="Avatar" class="small-avatar">
                  <div class="user-info">
                    <span class="user-name">{{ follow.following?.username || ('Unknown User' | translate) }}</span>
                    <span class="user-bio">{{ follow.following?.bio || ('No bio available' | translate) }}</span>
                  </div>
                  <div class="user-actions">
                     <button 
                       mat-stroked-button 
                       color="warn"
                       (click)="unfollowUser(follow.following?.id || '')"
                       [disabled]="followIsLoading$ | async">
                       @if (followIsLoading$ | async) {
                         <mat-spinner diameter="16"></mat-spinner>
                         {{ 'Unfollowing...' | translate }}
                       } @else {
                         {{ 'Unfollow' | translate }}
                       }
                     </button>
                  </div>
                </div>
              }
              @if (!(following$ | async) || (following$ | async)?.length === 0) {
                <div class="no-data">
                  <p>{{ 'Not following anyone yet' | translate }}</p>
                </div>
              }
            </div>
          }
        </div>
      }

    </div>
  }
</div>
