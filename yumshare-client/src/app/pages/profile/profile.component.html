<div class="profile-edit">
  <!-- Header -->
  <div class="profile-header">
    <h2>Edit Profile</h2>
    <button class="delete-account" (click)="showDialog = true">Delete account</button>

    @if (showDialog) {
      <div class="dialog-backdrop">
        <div class="dialog-box">
          <h3>Delete Account</h3>
          <p>Are you sure you want to delete your account?</p>
          <div class="dialog-actions">
            <button (click)="showDialog = false" class="cancel">Cancel</button>
            <button (click)="deleteAccount()" class="confirm">Delete</button>
          </div>
        </div>
      </div>
    }
  </div>

  <!-- Loading State -->
  @if (isLoading$ | async) {
    <div class="loading-state">
      <p>Loading profile...</p>
    </div>
  }

  <!-- Error State -->
  @if (error$ | async; as error) {
    <div class="error-state">
      <p>Error: {{ error }}</p>
    </div>
  }

  <!-- Profile Content -->
  @if (!(isLoading$ | async)) {
    <!-- Avatar + Info -->
    <div class="profile-info">
      <div class="avatar-section">
        <div class="avatar-container">
          <img [src]="avatarUrl || 'https://via.placeholder.com/80'" alt="Avatar" class="avatar">
          <input type="file" accept="image/*" (change)="onAvatarChange($event)" class="avatar-input">
        </div>
        <div>
          <h3>{{ profileForm.value.name }}</h3>
          <div class="bio-section">
            <textarea 
              class="bio-input" 
              placeholder="Write something about yourself..."
              [(ngModel)]="introduce"
              (focus)="startEditBio()"
              (blur)="stopEditBio()"
              (keydown)="onBioKeyDown($event)"
            ></textarea>
            <span class="edit-icon" (click)="toggleBioEdit()">
              <img style="height: 15px; padding-left: 10px" src="https://cdn.pixabay.com/photo/2019/04/08/20/26/pencil-4112898_960_720.png" alt="">
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Form -->
    <form [formGroup]="profileForm" class="profile-form" (ngSubmit)="onSubmit()">
      <div class="form-row">
        <div class="form-group">
          <label>Name</label>
          <input type="text" formControlName="name">
        </div>
        <div class="form-group">
          <label>Location</label>
          <input type="text" formControlName="location">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>E-mail</label>
          <input type="email" formControlName="email">
        </div>
        <div class="form-group">
          <label>Phone</label>
          <input type="text" formControlName="phone">
        </div>
      </div>

      <!-- Social -->
      <div class="social-links">
        <a href="https://www.linkedin.com/"><i class="fab fa-linkedin">
          <img style="height: 25px;border-radius: 5px" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJbSJIAAAAaVBMVEUAAAD////m5ua2trZUVFT8/Pybm5saGhoEBARaWlpXV1d/f3/5+fnFxcWnp6d4eHi8vLw+Pj4TExNPT08yMjIhISEpKSliYmKvr6/e3t5ycnKjo6ONjY1qamrJycmUlJTW1tZFRUXx8fFTEN6uAAADCklEQVR4nO3ba3OiMBSAYaLG4h2t1ktt6/b//8hFK9HKwbps6AmZ9/m0s3acvMMtAUwSAAAAAAAAAAAAAAAAAAAAAAAAAEA7pdoD+AVvr9lk0t3PtcfRhHz7LabWnHVm0W3RPGc0Nle2y9gSk42x1m3D/F92EFli15T0tMfk1agcaMZP2qPyaGGskDjRHpY3aTIV+vLoiK4aY7mwG83J5k0KPB6J2gPzRtxJj6LZTbOqwp32yHx5ryocaY/Ml0lV4Ux7ZL4IE5ovA+2R+fJRVbjQHpkvzxWBHe2B+dORCz+0x+WPNPHOJzXaw/JJ3Ih77VF5k6bJUlhbvGuPy6+1sd8irdlqD8mvNBncrC8O0d2LShbXM5vx/rTzRiXP+ZN9nq+DEV0mLtLTJlu+jWbDlfZYgKZFdoK69jKfv2iPoTHrzbaYKmw3Ia4q0yeR+3whfLg6LR6PZ+Dn7Ga2MM56xck5FMPjY5mSYnmYJl3h89NNnDxifZBm7Yd1WAdkT1w9XRbA4m2O0bHhSew7Na5CmhXVLUx20vOOQkj3seoWTsUnOl/y/XijmHSjZmHlneTCezDHYq3CXWbEJzqOHYfzgK5W4Vb6z1ubQE43dQrtnWPw6o92YeyotbahfajQhvGsvFbhg8I4FBsstOZZMcxptDCIS0aThdYsFcsKTR6HxvQVywrNFobwCKvZQhPAyr/hwgBeeGi48FUx7ax+4WVec2eKkymmndUuPGZN+rPdvnggIDqohTn/sQ3dpWBUvZQK4GRas9CazvXVvPKWTYsLP7/fUKtKbG9h6c2+ih21vYXT2++R3+loceGqtGqQz6itLTyUv0j+w9YWbsoLP3k3bW1hv1y4jq2wZEChFgopdChUQyGFDoVqKKTQoVANhRQ6FKqhkEIn/sIhhVoopNChUA2FFDoUqqGQQodCNRQ+XPjTF6mJv/D+zpVW/AyvPXtpmsyzbll2eW1tL34uvL4tflG39P7br/vhNy2P/+Sl6i8D+NEMAAAAAAAAAAAAAAAAAAAAAAAAAOCf/AXQ2ikddJe40wAAAABJRU5ErkJggg==">
        </i></a>
        <a href="https://www.facebook.com/?locale=vi_VN"><i class="fab fa-facebook">
          <img style="height: 25px;border-radius: 5px" src="https://cdn.pixabay.com/photo/2016/11/05/08/42/facebook-1799691_1280.png" alt="">
        </i></a>
        <a href="https://x.com/?lang=vi"><i class="fab fa-x-twitter">
          <img style="height: 25px;border-radius: 5px" src="https://img.freepik.com/vector-mien-phi/thiet-ke-bieu-tuong-x-logo-twitter-moi-nam-2023_1017-45418.jpg?semt=ais_hybrid&w=740&q=80">
        </i></a>
        <a href="https://www.instagram.com/"><i class="fab fa-instagram">
          <img style="height: 25px;border-radius: 5px" src="data:image/png;base64,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">
        </i></a>
      </div>

      <!-- Buttons -->
      <div class="form-actions">
        <button type="submit" class="btn save" [disabled]="profileForm.invalid || (isLoading$ | async)">Save</button>
        <button type="button" class="btn cancel" (click)="onCancel()" [disabled]="isLoading$ | async">Cancel</button>
      </div>
    </form>

                   <!-- Followers/Following Tabs -->
            <div class="social-tabs">
        <button class="tab-button" [class.active]="activeTab === 'followers'" (click)="setActiveTab('followers'); loadFollowers()">Followers ({{ followerCount$ | async }})</button>
        <button class="tab-button" [class.active]="activeTab === 'following'" (click)="setActiveTab('following'); loadFollowing()">Following ({{ followingCount$ | async }})</button>
        
      </div>

    <!-- Followers/Following Content -->
          <div class="social-content">

      <!-- Loading State -->
      @if (followIsLoading$ | async) {
        <div class="loading-state">
          <p>Loading...</p>
        </div>
      }

      <!-- Error State -->
      @if (followError$ | async; as error) {
        <div class="error-state">
          <p>Error: {{ error }}</p>
        </div>
      }

                     <!-- Followers Tab -->
        @if (activeTab === 'followers' && !(followIsLoading$ | async)) {
          <div class="followers">
            <ul>
              @for (follow of (followers$ | async) || []; track follow.id) {
                <li class="social-item">
                  <img [src]="follow.follower?.avatar_url || 'https://via.placeholder.com/40'" alt="Avatar" class="small-avatar">
                  <div class="user-info">
                    <span class="user-name">{{ follow.follower?.username || 'Unknown User' }}</span>
                    <span class="user-bio">{{ follow.follower?.bio || 'No bio available' }}</span>
                  </div>
                  <div class="user-actions">
                    <button 
                      class="follow-btn"
                      (click)="followUser(follow.follower?.id || '')"
                      [disabled]="followIsLoading$ | async">
                      Follow
                    </button>
                  </div>
                </li>
              }
              @if (!(followers$ | async) || (followers$ | async)?.length === 0) {
                <li class="no-data">
                  <p>No followers yet</p>
                </li>
              }
              
              <!-- Load More Button for Followers -->
              @if (hasMoreFollowers && (followers$ | async)?.length > 0) {
                <li class="load-more-container">
                  <button 
                    class="load-more-btn"
                    (click)="loadMoreFollowers()"
                    [disabled]="isLoadingMore">
                    @if (isLoadingMore) {
                      <span class="loading-spinner"></span>
                    }
                    Load More Followers
                  </button>
                </li>
              }
            </ul>
          </div>
        }

                     <!-- Following Tab -->
        @if (activeTab === 'following' && !(followIsLoading$ | async)) {
          <div class="following">
            <ul>
              @for (follow of (following$ | async) || []; track follow.id) {
                <li class="social-item">
                  <img [src]="follow.following?.avatar_url || 'https://via.placeholder.com/40'" alt="Avatar" class="small-avatar">
                  <div class="user-info">
                    <span class="user-name">{{ follow.following?.username || 'Unknown User' }}</span>
                    <span class="user-bio">{{ follow.following?.bio || 'No bio available' }}</span>
                  </div>
                  <div class="user-actions">
                    <button 
                      class="unfollow-btn"
                      (click)="unfollowUser(follow.following?.id || '')"
                      [disabled]="followIsLoading$ | async">
                      Unfollow
                    </button>
                  </div>
                </li>
              }
              @if (!(following$ | async) || (following$ | async)?.length === 0) {
                <li class="no-data">
                  <p>Not following anyone yet</p>
                </li>
              }
              
              <!-- Load More Button for Following -->
              @if (hasMoreFollowing && (following$ | async)?.length > 0) {
                <li class="load-more-container">
                  <button 
                    class="load-more-btn"
                    (click)="loadMoreFollowing()"
                    [disabled]="isLoadingMore">
                    @if (isLoadingMore) {
                      <span class="loading-spinner"></span>
                    }
                    Load More Following
                  </button>
                </li>
              }
            </ul>
          </div>
        }
    </div>
  }
</div>