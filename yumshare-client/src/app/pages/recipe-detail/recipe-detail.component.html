<!-- Loading State -->
@if (recipeLoading$ | async) {
  <div class="recipe-loading-container">
    <app-loading
      size="large"
      [message]="'Loading recipe...' | translate"
      centerType="center-container">
    </app-loading>
  </div>
}

<!-- Recipe Content -->
@if (!(recipeLoading$ | async)) {
  <div class="container-right">
    @if (recipe$ | async; as recipe) {
      <div class="top">
        <div class="food-name">
          <h1 class="title">{{ recipe.title }}</h1>
        </div>
        <div class="describe">
          <div class="lefttt">
            <div appLazyImage
                 [appLazyImage]="recipe.image_url || 'assets/default-recipe.jpg'"
                 [appLazyImageOptions]="{ quality: 0.9, maxWidth: 800, maxHeight: 600, generateThumbnail: true, thumbnailSize: 400 }"
                 [appLazyImagePriority]="true"
                 class="hinh-mon-an-container">
            </div>
          </div>
          <div class="righttt">
            <p class="food-description">{{ recipe.description }}</p>
            <div class="block">
              <mat-chip>{{ recipe.difficulty | translate }}</mat-chip>
              <mat-chip>{{ recipe.total_cooking_time }} {{ 'min' | translate }}</mat-chip>
              <mat-chip>{{ recipe.country | translate }}</mat-chip>
            </div>
          </div>
        </div>
      </div>
    }

    @if (recipe$ | async; as recipe) {
      <div class="middle">
        <div class="left">
          <h1 class="title">{{ 'Ingredients' | translate }}</h1>
          <p class="serving">{{ 'Serving' | translate }}: {{ recipe.servings }}</p>
          <div class="ingredient-list">
            <!-- Use Virtual Scrolling for large ingredient lists -->
            @if (recipe.ingredients.length > 15) {
              <div class="virtual-scroll-container">
                <cdk-virtual-scroll-viewport [itemSize]="ingredientItemSize" class="ingredient-viewport">
                  @for (ingredient of recipe.ingredients; track trackByIngredient($index, ingredient); let i = $index) {
                    <div class="row">
                      <p>{{ ingredient }}</p>
                    </div>
                  }
                </cdk-virtual-scroll-viewport>
              </div>
            } @else {
              <!-- Regular scroll for small ingredient lists -->
              <div class="regular-ingredient-list">
                @for (ingredient of recipe.ingredients; track trackByIngredient($index, ingredient); let i = $index) {
                  <div class="row">
                    <p>{{ ingredient }}</p>
                  </div>
                }
              </div>
            }
          </div>
          <div class="user-box">
            <span class="label">{{ 'Up by:' | translate }}</span>
            <div class="user-info">
              <div class="avatar" [style.background-image]="'url(' + (recipe.user?.avatar_url || 'assets/default-avatar.png') + ')'"></div>
              <span class="username">{{ recipe.user?.username || ('Unknown User' | translate) }}</span>
            </div>
            @if (recipe.user?.id !== (currentUser$ | async)?.uid && (currentUser$ | async)) {
              <mat-checkbox
                class="follow-toggle"
                [(ngModel)]="isFollowed"
                (change)="onFollowToggle($event)"
                [disabled]="followLoading$ | async">
                {{ isFollowed ? ('Followed' | translate) : ('Follow' | translate) }}
              </mat-checkbox>
            }
            @if (recipe.user?.id !== (currentUser$ | async)?.uid && !(currentUser$ | async)) {
              <button
                class="login-required-btn"
                (click)="onLoginRequired()">
                {{ "Đăng nhập để Follow" | translate }}
              </button>
            }
          </div>
          <div class="post-like">
            {{ 'Like for this recipe:' | translate }}
            <button mat-icon-button (click)="toggleLike()" [disabled]="likeLoading$ | async">
              <mat-icon [style.color]="(isLiked$ | async) ? '#000' : '#e0e0e0'">thumb_up</mat-icon>
            </button>
            <span>{{ likeCount$ | async }}</span>
          </div>
        </div>

        <div class="right">
          <h1 class="title2">{{ 'Process Steps' | translate }}</h1>
          <!-- Use Virtual Scrolling for large step lists -->
          @if (recipe.steps.length > 8) {
            <div class="virtual-scroll-container">
              <cdk-virtual-scroll-viewport [itemSize]="stepItemSize" class="step-viewport">
                @for (step of recipe.steps; track trackByStep($index, step); let i = $index) {
                  <div class="instruction">
                    <div class="instruction-box">
                      <div class="step">
                        <h1 class="step-number">{{ 'Step' | translate }} {{ i + 1 }}</h1>
                      </div>
                      <div class="step-detail">
                        <p class="cooking">{{ step.description }}</p>
                        @if (step.image_url) {
                          <div appLazyImage 
                               [appLazyImage]="step.image_url"
                               [appLazyImageOptions]="{ quality: 0.8, maxWidth: 500, maxHeight: 300, generateThumbnail: true, thumbnailSize: 250 }"
                               class="step-image-container">
                          </div>
                        }
                      </div>
                    </div>
                  </div>
                }
              </cdk-virtual-scroll-viewport>
            </div>
          } @else {
            <!-- Regular scroll for small step lists -->
            <div class="regular-step-list">
              @for (step of recipe.steps; track trackByStep($index, step); let i = $index) {
                <div class="instruction">
                  <div class="instruction-box">
                    <div class="step">
                      <h1 class="step-number">{{ 'Step' | translate }} {{ i + 1 }}</h1>
                    </div>
                    <div class="step-detail">
                      <p class="cooking">{{ step.description }}</p>
                      @if (step.image_url) {
                        <div appLazyImage 
                             [appLazyImage]="step.image_url"
                             [appLazyImageOptions]="{ quality: 0.8, maxWidth: 500, maxHeight: 300, generateThumbnail: true, thumbnailSize: 250 }"
                             class="step-image-container">
                        </div>
                      }
                    </div>
                  </div>
                </div>
              }
            </div>
          }
        </div>
      </div>
    }

    @if (recipe$ | async; as recipe) {
      <div class="bottom">
        @if (recipe.video_url || recipe.video) {
          <div class="video">
            <h1 class="title3">{{ 'Video Tutorial' | translate }}</h1>
            
            @if (recipe.video_url) {
              @if (getVideoElementType(recipe.video_url) === 'iframe') {
                <iframe
                  class="clip"
                  width="650"
                  height="400"
                  [src]="getVideoEmbedUrl(recipe.video_url) | safe"
                  [title]="'Recipe Video Tutorial' | translate"
                  [attr.frameborder]="getVideoAttributes(recipe.video_url).frameborder"
                  [attr.allow]="getVideoAttributes(recipe.video_url).allow"
                  [attr.allowfullscreen]="getVideoAttributes(recipe.video_url).allowfullscreen">
                </iframe>
              } @else {
                <video
                  class="clip"
                  width="650"
                  height="400"
                  [src]="getVideoEmbedUrl(recipe.video_url)"
                  [controls]="getVideoAttributes(recipe.video_url).controls"
                  [preload]="getVideoAttributes(recipe.video_url).preload"
                  [playsinline]="getVideoAttributes(recipe.video_url).playsinline"
                  [title]="'Recipe Video Tutorial' | translate">
                </video>
              }
            }
            
            @if (recipe.video) {
              @if (getVideoElementType(recipe.video) === 'iframe') {
                <iframe
                  class="clip"
                  width="650"
                  height="400"
                  [src]="getVideoEmbedUrl(recipe.video) | safe"
                  [title]="'Recipe Video Tutorial' | translate"
                  [attr.frameborder]="getVideoAttributes(recipe.video).frameborder"
                  [attr.allow]="getVideoAttributes(recipe.video).allow"
                  [attr.allowfullscreen]="getVideoAttributes(recipe.video).allowfullscreen">
                </iframe>
              } @else {
                <video
                  class="clip"
                  width="650"
                  height="400"
                  [src]="getVideoEmbedUrl(recipe.video)"
                  [controls]="getVideoAttributes(recipe.video).controls"
                  [preload]="getVideoAttributes(recipe.video).preload"
                  [playsinline]="getVideoAttributes(recipe.video).playsinline"
                  [title]="'Recipe Video Tutorial' | translate">
                </video>
              }
            }
          </div>
        } @else {
          <div class="video">
            <h1 class="title3">{{ 'Video Tutorial' | translate }}</h1>
            <div class="no-video-message">
              {{ 'We will update soon' | translate }}
            </div>
          </div>
        }
        <div class="bottom-under">
          <app-comment style="margin-top: 1rem;"
                       [recipeId]="recipeId"
                       (commentAdded)="onCommentAdded($event)"
                       (commentDeleted)="onCommentDeleted($event)">
          </app-comment>
        </div>
      </div>
    }
  </div>
}

<!-- No Recipe Found -->
@if (!(recipeLoading$ | async) && !(recipe$ | async)) {
  <div class="no-recipe">
    <p>{{ 'Recipe not found' | translate }}</p>
    <button (click)="router.navigate(['/'])" class="back-btn">{{ 'Back to Home' | translate }}</button>
  </div>
}