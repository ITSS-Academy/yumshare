<!-- Loading State -->
@if (recipeLoading$ | async) {
  <div class="recipe-loading-container">
    <app-loading 
      size="large"
      message="Loading recipe..."
      centerType="center-container">
    </app-loading>
  </div>
}

<!-- Recipe Content -->
@if (!(recipeLoading$ | async)) {
  <div class="container-right">
    @if (recipe$ | async; as recipe) {
      <div class="top">
        <div class="food-name">
          <h1 class="title">{{ recipe.title }}</h1>
        </div>
        <div class="mieu-ta">
          <div class="trai">
            <div appLazyImage 
                 [appLazyImage]="recipe.image_url || 'assets/default-recipe.jpg'"
                 [appLazyImageOptions]="{ quality: 0.9, maxWidth: 800, maxHeight: 600, generateThumbnail: true, thumbnailSize: 400 }"
                 [appLazyImagePriority]="true"
                 class="hinh-mon-an-container">
            </div>
          </div>
          <div class="phai">
            <p class="mieu-ta-monan">{{ recipe.description }}</p>
            <div class="block">
              <mat-chip>{{ recipe.difficulty }}</mat-chip>
              <mat-chip>{{ recipe.total_cooking_time }} min</mat-chip>
              <mat-chip>{{ recipe.country }}</mat-chip>
            </div>
          </div>
        </div>
      </div>
    }

    @if (recipe$ | async; as recipe) {
      <div class="middle">
        <div class="left">
          <h1 class="title">Ingredients</h1>
          <p class="serving">Serving: {{ recipe.servings }}</p>
          <div class="ingredient-list">
            <!-- Use Virtual Scrolling for large ingredient lists -->
            @if (recipe.ingredients.length > 15) {
              <div class="virtual-scroll-container">
                <cdk-virtual-scroll-viewport [itemSize]="ingredientItemSize" class="ingredient-viewport">
                  @for (ingredient of recipe.ingredients; track trackByIngredient($index, ingredient); let i = $index) {
                    <div class="row">
                      <p>{{ ingredient }}</p>
                    </div>
                  }
                </cdk-virtual-scroll-viewport>
              </div>
            } @else {
              <!-- Regular scroll for small ingredient lists -->
              <div class="regular-ingredient-list">
                @for (ingredient of recipe.ingredients; track trackByIngredient($index, ingredient); let i = $index) {
                  <div class="row">
                    <p>{{ ingredient }}</p>
                  </div>
                }
              </div>
            }
          </div>

          <div class="user-box">
            <span class="label">Up by:</span>
            <div class="user-info">
              <div class="avatar" [style.background-image]="'url(' + (recipe.user?.avatar_url || 'assets/default-avatar.png') + ')'"></div>
              <span class="username">{{ recipe.user?.username || 'Unknown User' }}</span>
            </div>
            @if (recipe.user?.id !== (currentUser$ | async)?.uid && (currentUser$ | async)) {
              <mat-checkbox
                class="follow-toggle"
                [(ngModel)]="isFollowed"
                (change)="onFollowToggle($event)"
                [disabled]="followLoading$ | async">
                {{ isFollowed ? 'Followed' : 'Follow' }}
              </mat-checkbox>
            }
            @if (recipe.user?.id !== (currentUser$ | async)?.uid && !(currentUser$ | async)) {
              <button
                class="login-required-btn"
                (click)="onLoginRequired()">
                Đăng nhập để Follow
              </button>
            }
          </div>
        </div>

        <div class="right">
          <h1 class="title2">Process Steps</h1>
          <!-- Use Virtual Scrolling for large step lists -->
          @if (recipe.steps.length > 8) {
            <div class="virtual-scroll-container">
              <cdk-virtual-scroll-viewport [itemSize]="stepItemSize" class="step-viewport">
                @for (step of recipe.steps; track trackByStep($index, step); let i = $index) {
                  <div class="instruction">
                    <div class="instruction-box">
                      <div class="step">
                        <h1 class="step-number">{{ 'Step ' + (i + 1) }}</h1>
                      </div>
                      <div class="step-detail">
                        <p class="cooking">{{ step.description }}</p>
                        @if (step.image_url) {
                          <div appLazyImage 
                               [appLazyImage]="step.image_url"
                               [appLazyImageOptions]="{ quality: 0.8, maxWidth: 500, maxHeight: 300, generateThumbnail: true, thumbnailSize: 250 }"
                               class="step-image-container">
                          </div>
                        }
                      </div>
                    </div>
                  </div>
                }
              </cdk-virtual-scroll-viewport>
            </div>
          } @else {
            <!-- Regular scroll for small step lists -->
            <div class="regular-step-list">
              @for (step of recipe.steps; track trackByStep($index, step); let i = $index) {
                <div class="instruction">
                  <div class="instruction-box">
                    <div class="step">
                      <h1 class="step-number">{{ 'Step ' + (i + 1) }}</h1>
                    </div>
                    <div class="step-detail">
                      <p class="cooking">{{ step.description }}</p>
                      @if (step.image_url) {
                        <div appLazyImage 
                             [appLazyImage]="step.image_url"
                             [appLazyImageOptions]="{ quality: 0.8, maxWidth: 500, maxHeight: 300, generateThumbnail: true, thumbnailSize: 250 }"
                             class="step-image-container">
                        </div>
                      }
                    </div>
                  </div>
                </div>
              }
            </div>
          }
        </div>
      </div>
    }

    @if (recipe$ | async; as recipe) {
      <div class="bottom">
        @if (recipe.video_url) {
          <div class="video">
            <h1 class="title3">Video Tutorial</h1>
            <iframe
              class="clip"
              width="650"
              height="400"
              [src]="getYouTubeEmbedUrl(recipe.video_url) | safe"
              title="Recipe Video Tutorial"
              frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
              allowfullscreen>
            </iframe>
          </div>
        }

        <app-comment style="margin-top: 1rem;"
          [recipeId]="recipeId"
          [recipeTitle]="recipe.title"
          [recipeOwnerId]="recipe.user?.id"
          (commentAdded)="onCommentAdded($event)"
          (commentDeleted)="onCommentDeleted($event)">
        </app-comment>
      </div>
    }
  </div>
}

<!-- No Recipe Found -->
@if (!(recipeLoading$ | async) && !(recipe$ | async)) {
  <div class="no-recipe">
    <p>Recipe not found</p>
    <button (click)="router.navigate(['/'])" class="back-btn">Back to Home</button>
  </div>
}
