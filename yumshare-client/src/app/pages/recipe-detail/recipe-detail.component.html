<!-- Loading State -->
@if (recipeLoading$ | async) {
  <div class="recipe-loading-container">
    <app-loading
      size="large"
      message="Loading recipe..."
      centerType="center-container">
    </app-loading>
  </div>
}

<!-- Recipe Content -->
@if (!(recipeLoading$ | async)) {
  <div class="container-right">
    @if (recipe$ | async; as recipe) {
      <div class="top">
        <div class="food-name">
          <h1 class="title">{{ recipe.title }}</h1>
        </div>
        <div class="describe">
          <div class="lefttt">
            <div appLazyImage
                 [appLazyImage]="recipe.image_url || 'assets/default-recipe.jpg'"
                 [appLazyImageOptions]="{ quality: 0.9, maxWidth: 800, maxHeight: 600, generateThumbnail: true, thumbnailSize: 400 }"
                 [appLazyImagePriority]="true"
                 class="hinh-mon-an-container">
            </div>
          </div>
          <div class="righttt">
            <p class="food-description">{{ recipe.description }}</p>
            <div class="block">
              <mat-chip>{{ recipe.difficulty }}</mat-chip>
              <mat-chip>{{ recipe.total_cooking_time }} min</mat-chip>
              <mat-chip>{{ recipe.country }}</mat-chip>
            </div>
          </div>
        </div>
      </div>
    }

    @if (recipe$ | async; as recipe) {
      <div class="middle">
        <div class="left">
          <h1 class="title">Ingredients</h1>
          <p class="serving">Serving: {{ recipe.servings }}</p>
          <div class="ingredient-list">
            @for (ingredient of recipe.ingredients; track i; let i = $index) {
              <div class="row">
                <p>{{ ingredient }}</p>
              </div>
            }
          </div>
          <div class="user-box">
            <span class="label">Up by:</span>
            <div class="user-info">
              <div class="avatar" [style.background-image]="'url(' + (recipe.user?.avatar_url || 'assets/default-avatar.png') + ')'"></div>
              <span class="username">{{ recipe.user?.username || 'Unknown User' }}</span>
            </div>
            @if (recipe.user?.id !== (currentUser$ | async)?.uid && (currentUser$ | async)) {
              <mat-checkbox
                class="follow-toggle"
                [(ngModel)]="isFollowed"
                (change)="onFollowToggle($event)"
                [disabled]="followLoading$ | async">
                {{ isFollowed ? 'Followed' : 'Follow' }}
              </mat-checkbox>
            }
            @if (recipe.user?.id !== (currentUser$ | async)?.uid && !(currentUser$ | async)) {
              <button
                class="login-required-btn"
                (click)="onLoginRequired()">
                Đăng nhập để Follow
              </button>
            }
          </div>
          <div class="post-like">
            Like for this recipe:
            <button mat-icon-button (click)="toggleLike()" [disabled]="likeLoading$ | async">
              <mat-icon [style.color]="(isLiked$ | async) ? '#000' : '#e0e0e0'">thumb_up</mat-icon>
            </button>
            <span>{{ likeCount$ | async }}</span>
          </div>
        </div>

        <div class="right">
          <h1 class="title2">Process Steps</h1>
          @for (step of recipe.steps; track step.id; let i = $index) {
            <div class="instruction">
              <div class="instruction-box">
                <div class="step">
                  <h1 class="step-number">{{ 'Step ' + (i + 1) }}</h1>
                </div>
                <div class="step-detail">
                  <p class="cooking">{{ step.description }}</p>
                  @if (step.image_url) {
                    <div appLazyImage
                         [appLazyImage]="step.image_url"
                         [appLazyImageOptions]="{ quality: 0.8, maxWidth: 500, maxHeight: 300, generateThumbnail: true, thumbnailSize: 250 }"
                         class="step-image-container">
                    </div>
                  }
                </div>
              </div>
            </div>
          }
        </div>
      </div>
    }

    @if (recipe$ | async; as recipe) {
      <div class="bottom">
        @if (recipe.video_url || recipe.video) {
          <div class="video">
            <h1 class="title3">Video Tutorial</h1>
            @if (recipe.video_url) {
              <iframe
                class="clip"
                width="650"
                height="400"
                [src]="getYouTubeEmbedUrl(recipe.video_url) | safe"
                title="Recipe Video Tutorial"
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen>
              </iframe>
            }
            @if (recipe.video) {
              <video
                class="clip"
                width="650"
                height="400"
                [src]="recipe.video"
                controls
                title="Recipe Video Tutorial">
              </video>
            }
          </div>
        } @else {
          <div class="video">
            <h1 class="title3">Video Tutorial</h1>
            <div class="no-video-message">
              We will update soon
            </div>
          </div>
        }
        <div class="bottom-under">
          <app-comment style="margin-top: 1rem;"
                       [recipeId]="recipeId"
                       (commentAdded)="onCommentAdded($event)"
                       (commentDeleted)="onCommentDeleted($event)">
          </app-comment>
        </div>
      </div>
    }
  </div>
}

<!-- No Recipe Found -->
@if (!(recipeLoading$ | async) && !(recipe$ | async)) {
  <div class="no-recipe">
    <p>Recipe not found</p>
    <button (click)="router.navigate(['/'])" class="back-btn">Back to Home</button>
  </div>
}