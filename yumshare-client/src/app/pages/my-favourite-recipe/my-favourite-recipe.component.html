<div class="content-container">
  <div class="my-recipe-header">
    <h1>My Favourite Recipes</h1>
    <p>Here, you can manage all your favourite recipes. Feel free to click on any recipe to view or remove it from your
      favourites. Enjoy exploring and saving your best-loved dishes!</p>
  </div>

  <div class="sort-and-category">
    <div class="difficulty">
      <button mat-button [matMenuTriggerFor]="Difficulty">
        {{ selectedDifficulty }}<span class="material-symbols-outlined">arrow_drop_down</span>
      </button>
      <mat-menu #Difficulty="matMenu">
        <button mat-menu-item (click)="clearDifficultyFilter()">All Difficulties</button>
        <button mat-menu-item (click)="setDifficulty('Easy')">Easy</button>
        <button mat-menu-item (click)="setDifficulty('Medium')">Medium</button>
        <button mat-menu-item (click)="setDifficulty('Hard')">Hard</button>
      </mat-menu>
    </div>

    <div class="category">
      <button mat-button [matMenuTriggerFor]="Category">
        {{ selectedCategory }}<span class="material-symbols-outlined">arrow_drop_down</span>
      </button>
      <mat-menu #Category="matMenu">
        <button mat-menu-item (click)="clearCategoryFilter()">All Categories</button>
        @for (category of activeCategories$ | async; track category.id) {
          <button mat-menu-item (click)="setCategory(category)">{{ category.name }}</button>
        }
      </mat-menu>
    </div>
  </div>

  <div class="container">
    @if (favoritesLoading$ | async) {
      <div class="loading-container">
        <mat-spinner></mat-spinner>
        <p>Đang tải danh sách yêu thích...</p>
      </div>
    } @else if (isEmpty$ | async) {
      <div class="empty-state">
        <mat-icon class="empty-icon">favorite_border</mat-icon>
        <h3>Chưa có công thức yêu thích nào</h3>
        <p>Hãy khám phá và thêm những công thức bạn yêu thích vào danh sách này!</p>
      </div>
    } @else {
      @for (favorite of displayedRecipes$ | async; track favorite.id) {
        <div class="recipe-card">
          <!-- Bên trái: ảnh món ăn -->
          <div class="recipe-image">
            <img [src]="favorite.recipe?.image_url || 'assets/default-recipe.jpg'" 
                 [alt]="favorite.recipe?.title || 'Recipe Image'">
          </div>

          <!-- Bên phải: nội dung -->
          <div class="recipe-content">
            <!-- Trên: tiêu đề + tác giả -->
            <div class="recipe-header">
              <div class="name-and-author">
                <h3 class="recipe-title">{{ favorite.recipe?.title || 'Untitled Recipe' }}</h3>
                <p class="recipe-author">by {{ favorite.recipe?.user?.displayName || favorite.recipe?.user?.email || 'Unknown Author' }}</p>
              </div>
              <div class="example-button-row">
                <div class="example-flex-container">
                  <button mat-icon-button class="favourite-btn" (click)="toggleFavourite(favorite)">
                    <mat-icon class="filled">favorite</mat-icon>
                  </button>
                </div>
              </div>
            </div>

            <!-- Giữa: mô tả -->
            <div class="recipe-description">
              <p>{{ favorite.recipe?.description || 'Không có mô tả' }}</p>
            </div>

            <!-- Dưới: ngày đăng -->
            <div class="recipe-footer">
              <span class="recipe-date">{{ favorite.created_at | date:'dd/MM/yyyy' }}</span>
            </div>
          </div>
        </div>
      }
    }
  </div>

  @if (!(isEmpty$ | async)) {
    <div class="pages-navigation">
      <div class="example-button-row">
        <div class="example-flex-container">
          <div class="example-button-container">
            <button mat-mini-fab aria-label="First page" (click)="goToFirst()"
              [disabled]="pageIndex === 0">&lt;&lt;</button>
            <button mat-mini-fab aria-label="Previous page" (click)="goToPrev()"
              [disabled]="pageIndex === 0">&lt;</button>
            
            @if (pageNumbers$ | async; as pageNumbers) {
              @if (pageNumbers[0] > 0) {
                <button mat-mini-fab (click)="goToPage(0)">1</button>
                @if (pageNumbers[0] > 1) {
                  <span>...</span>
                }
              }
              
              @for (page of pageNumbers; track page) {
                <button mat-mini-fab [class.active]="page === pageIndex" (click)="goToPage(page)">
                  {{ page + 1 }}
                </button>
              }
              
              @if (totalPages$ | async; as totalPages) {
                @if (pageNumbers[pageNumbers.length - 1] < totalPages - 1) {
                  @if (pageNumbers[pageNumbers.length - 1] < totalPages - 2) {
                    <span>...</span>
                  }
                  <button mat-mini-fab (click)="goToPage(totalPages - 1)">{{ totalPages }}</button>
                }
              }
            }
            
            @if (totalPages$ | async; as totalPages) {
              <button mat-mini-fab aria-label="Next page" (click)="goToNext()"
                [disabled]="pageIndex === totalPages - 1">&gt;</button>
              <button mat-mini-fab aria-label="Last page" (click)="goToLast()"
                [disabled]="pageIndex === totalPages - 1">&gt;&gt;</button>
            }
          </div>
        </div>
      </div>
    </div>
  }
</div>